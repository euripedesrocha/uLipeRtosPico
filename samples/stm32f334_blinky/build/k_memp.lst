ARM GAS  /tmp/ccTHXFXt.s 			page 1


   1              		.cpu cortex-m4
   2              		.eabi_attribute 27, 1
   3              		.eabi_attribute 28, 1
   4              		.eabi_attribute 20, 1
   5              		.eabi_attribute 21, 1
   6              		.eabi_attribute 23, 3
   7              		.eabi_attribute 24, 1
   8              		.eabi_attribute 25, 1
   9              		.eabi_attribute 26, 1
  10              		.eabi_attribute 30, 1
  11              		.eabi_attribute 34, 1
  12              		.eabi_attribute 18, 4
  13              		.file	"k_memp.c"
  14              		.text
  15              	.Ltext0:
  16              		.cfi_sections	.debug_frame
  17              		.section	.text.k_block_alloc,"ax",%progbits
  18              		.align	1
  19              		.global	k_block_alloc
  20              		.syntax unified
  21              		.thumb
  22              		.thumb_func
  23              		.fpu fpv4-sp-d16
  25              	k_block_alloc:
  26              	.LFB20:
  27              		.file 1 "../../picokernel/k_memp.c"
   1:../../picokernel/k_memp.c **** /**
   2:../../picokernel/k_memp.c ****  * 							ULIPE RTOS PICO
   3:../../picokernel/k_memp.c ****  *
   4:../../picokernel/k_memp.c ****  *  @file k_memp.h
   5:../../picokernel/k_memp.c ****  *
   6:../../picokernel/k_memp.c ****  *  @brief fixed size memory block allocator
   7:../../picokernel/k_memp.c ****  *
   8:../../picokernel/k_memp.c ****  *
   9:../../picokernel/k_memp.c ****  */
  10:../../picokernel/k_memp.c **** 
  11:../../picokernel/k_memp.c **** #include "ulipe_rtos_pico.h"
  12:../../picokernel/k_memp.c **** 
  13:../../picokernel/k_memp.c **** 
  14:../../picokernel/k_memp.c **** #if(K_ENABLE_MEMORY_POOLS > 0)
  15:../../picokernel/k_memp.c **** #define SMALL_BLOCK_BMP_LIMIT	31
  16:../../picokernel/k_memp.c **** 
  17:../../picokernel/k_memp.c **** 
  18:../../picokernel/k_memp.c **** void *k_block_alloc(pool_info_t *mem){
  28              		.loc 1 18 0
  29              		.cfi_startproc
  30              		@ args = 0, pretend = 0, frame = 0
  31              		@ frame_needed = 0, uses_anonymous_args = 0
  32              	.LVL0:
  33 0000 F8B5     		push	{r3, r4, r5, r6, r7, lr}
  34              	.LCFI0:
  35              		.cfi_def_cfa_offset 24
  36              		.cfi_offset 3, -24
  37              		.cfi_offset 4, -20
  38              		.cfi_offset 5, -16
  39              		.cfi_offset 6, -12
  40              		.cfi_offset 7, -8
ARM GAS  /tmp/ccTHXFXt.s 			page 2


  41              		.cfi_offset 14, -4
  42 0002 0446     		mov	r4, r0
  43              	.LVL1:
  19:../../picokernel/k_memp.c **** 	void *ret = NULL;
  20:../../picokernel/k_memp.c **** 
  21:../../picokernel/k_memp.c **** 
  22:../../picokernel/k_memp.c **** 	archtype_t key = port_irq_lock();
  44              		.loc 1 22 0
  45 0004 FFF7FEFF 		bl	port_irq_lock
  46              	.LVL2:
  47 0008 0546     		mov	r5, r0
  48              	.LVL3:
  23:../../picokernel/k_memp.c **** 
  24:../../picokernel/k_memp.c **** 	/* check memory pool pointer */
  25:../../picokernel/k_memp.c **** 	if(mem != NULL) {
  49              		.loc 1 25 0
  50 000a 94B3     		cbz	r4, .L5
  51              	.LBB2:
  26:../../picokernel/k_memp.c **** 		uint32_t x;
  27:../../picokernel/k_memp.c **** 		uint32_t y;
  28:../../picokernel/k_memp.c **** 
  29:../../picokernel/k_memp.c **** 		/* maps the block using bitmap current state */
  30:../../picokernel/k_memp.c **** 		if(mem->bitmap_h) {
  52              		.loc 1 30 0
  53 000c 2068     		ldr	r0, [r4]
  54              	.LVL4:
  55 000e 20BB     		cbnz	r0, .L8
  56              	.L3:
  57              	.LVL5:
  31:../../picokernel/k_memp.c **** 			x = SMALL_BLOCK_BMP_LIMIT - port_bit_fs_scan(mem->bitmap_h);
  32:../../picokernel/k_memp.c **** 			y = SMALL_BLOCK_BMP_LIMIT - port_bit_fs_scan(mem->bitmap_l[x]);
  33:../../picokernel/k_memp.c **** 		}
  34:../../picokernel/k_memp.c **** 
  35:../../picokernel/k_memp.c **** 		uint32_t block_pos = (x << 5) | y;
  58              		.loc 1 35 0
  59 0010 47EA4612 		orr	r2, r7, r6, lsl #5
  60              	.LVL6:
  36:../../picokernel/k_memp.c **** 
  37:../../picokernel/k_memp.c **** 		/* at least 1 block is free */
  38:../../picokernel/k_memp.c **** 		if(mem->numblocks){
  61              		.loc 1 38 0
  62 0014 B4F88830 		ldrh	r3, [r4, #136]
  63 0018 6BB3     		cbz	r3, .L6
  64              	.LBB3:
  39:../../picokernel/k_memp.c **** 
  40:../../picokernel/k_memp.c **** 			/* obtains its address */
  41:../../picokernel/k_memp.c **** 			int block_address = mem->block_size * block_pos;
  65              		.loc 1 41 0
  66 001a D4F88410 		ldr	r1, [r4, #132]
  67 001e 01FB02F1 		mul	r1, r1, r2
  68              	.LVL7:
  42:../../picokernel/k_memp.c **** 
  43:../../picokernel/k_memp.c **** 			/* mark as used block */
  44:../../picokernel/k_memp.c **** 			mem->bitmap_l[x] &= ~(1 << y);
  69              		.loc 1 44 0
  70 0022 0122     		movs	r2, #1
  71              	.LVL8:
ARM GAS  /tmp/ccTHXFXt.s 			page 3


  72 0024 02FA07F0 		lsl	r0, r2, r7
  73 0028 04EB8607 		add	r7, r4, r6, lsl #2
  74              	.LVL9:
  75 002c 7A68     		ldr	r2, [r7, #4]
  76 002e 22EA0002 		bic	r2, r2, r0
  77 0032 7A60     		str	r2, [r7, #4]
  45:../../picokernel/k_memp.c **** 			if(!mem->bitmap_l[x])
  78              		.loc 1 45 0
  79 0034 32B9     		cbnz	r2, .L4
  46:../../picokernel/k_memp.c **** 				mem->bitmap_h &= ~(1 << x);
  80              		.loc 1 46 0
  81 0036 0122     		movs	r2, #1
  82 0038 02FA06F6 		lsl	r6, r2, r6
  83              	.LVL10:
  84 003c 2268     		ldr	r2, [r4]
  85 003e 22EA0602 		bic	r2, r2, r6
  86 0042 2260     		str	r2, [r4]
  87              	.L4:
  47:../../picokernel/k_memp.c **** 
  48:../../picokernel/k_memp.c **** 			mem->numblocks--;
  88              		.loc 1 48 0
  89 0044 013B     		subs	r3, r3, #1
  90 0046 A4F88830 		strh	r3, [r4, #136]	@ movhi
  49:../../picokernel/k_memp.c **** 			ret = &mem->mem_pool[block_address];
  91              		.loc 1 49 0
  92 004a D4F88C40 		ldr	r4, [r4, #140]
  93              	.LVL11:
  94 004e 0C44     		add	r4, r4, r1
  95              	.LVL12:
  96              	.L2:
  97              	.LBE3:
  98              	.LBE2:
  50:../../picokernel/k_memp.c **** 
  51:../../picokernel/k_memp.c **** 		}
  52:../../picokernel/k_memp.c **** 	}
  53:../../picokernel/k_memp.c **** 
  54:../../picokernel/k_memp.c **** 	port_irq_unlock(key);
  99              		.loc 1 54 0
 100 0050 2846     		mov	r0, r5
 101 0052 FFF7FEFF 		bl	port_irq_unlock
 102              	.LVL13:
  55:../../picokernel/k_memp.c **** 
  56:../../picokernel/k_memp.c **** 	/* return the block address */
  57:../../picokernel/k_memp.c **** 	return(ret);
  58:../../picokernel/k_memp.c **** }
 103              		.loc 1 58 0
 104 0056 2046     		mov	r0, r4
 105 0058 F8BD     		pop	{r3, r4, r5, r6, r7, pc}
 106              	.LVL14:
 107              	.L8:
 108              	.LBB4:
  31:../../picokernel/k_memp.c **** 			y = SMALL_BLOCK_BMP_LIMIT - port_bit_fs_scan(mem->bitmap_l[x]);
 109              		.loc 1 31 0
 110 005a FFF7FEFF 		bl	port_bit_fs_scan
 111              	.LVL15:
 112 005e C0F11F06 		rsb	r6, r0, #31
 113              	.LVL16:
ARM GAS  /tmp/ccTHXFXt.s 			page 4


  32:../../picokernel/k_memp.c **** 		}
 114              		.loc 1 32 0
 115 0062 04EB8603 		add	r3, r4, r6, lsl #2
 116 0066 5868     		ldr	r0, [r3, #4]
 117 0068 FFF7FEFF 		bl	port_bit_fs_scan
 118              	.LVL17:
 119 006c C0F11F07 		rsb	r7, r0, #31
 120              	.LVL18:
 121 0070 CEE7     		b	.L3
 122              	.LVL19:
 123              	.L5:
 124              	.LBE4:
  19:../../picokernel/k_memp.c **** 
 125              		.loc 1 19 0
 126 0072 0024     		movs	r4, #0
 127              	.LVL20:
 128 0074 ECE7     		b	.L2
 129              	.LVL21:
 130              	.L6:
 131 0076 0024     		movs	r4, #0
 132              	.LVL22:
 133 0078 EAE7     		b	.L2
 134              		.cfi_endproc
 135              	.LFE20:
 137              		.section	.text.k_block_free,"ax",%progbits
 138              		.align	1
 139              		.global	k_block_free
 140              		.syntax unified
 141              		.thumb
 142              		.thumb_func
 143              		.fpu fpv4-sp-d16
 145              	k_block_free:
 146              	.LFB21:
  59:../../picokernel/k_memp.c **** 
  60:../../picokernel/k_memp.c **** 
  61:../../picokernel/k_memp.c **** 
  62:../../picokernel/k_memp.c **** void k_block_free(pool_info_t *mem, void *p){
 147              		.loc 1 62 0
 148              		.cfi_startproc
 149              		@ args = 0, pretend = 0, frame = 0
 150              		@ frame_needed = 0, uses_anonymous_args = 0
 151              	.LVL23:
 152 0000 70B5     		push	{r4, r5, r6, lr}
 153              	.LCFI1:
 154              		.cfi_def_cfa_offset 16
 155              		.cfi_offset 4, -16
 156              		.cfi_offset 5, -12
 157              		.cfi_offset 6, -8
 158              		.cfi_offset 14, -4
 159 0002 0546     		mov	r5, r0
 160 0004 0C46     		mov	r4, r1
  63:../../picokernel/k_memp.c **** 
  64:../../picokernel/k_memp.c **** 
  65:../../picokernel/k_memp.c **** 	archtype_t key = port_irq_lock();
 161              		.loc 1 65 0
 162 0006 FFF7FEFF 		bl	port_irq_lock
 163              	.LVL24:
ARM GAS  /tmp/ccTHXFXt.s 			page 5


  66:../../picokernel/k_memp.c **** 
  67:../../picokernel/k_memp.c **** 
  68:../../picokernel/k_memp.c **** 	/* check pointer */
  69:../../picokernel/k_memp.c **** 	if((p != NULL) && (mem != NULL)) {
 164              		.loc 1 69 0
 165 000a 04B3     		cbz	r4, .L10
 166              		.loc 1 69 0 is_stmt 0 discriminator 1
 167 000c FDB1     		cbz	r5, .L10
 168              	.LVL25:
 169              	.LBB5:
  70:../../picokernel/k_memp.c **** 		uint8_t x = 0;
  71:../../picokernel/k_memp.c **** 		uint8_t y = 0;
  72:../../picokernel/k_memp.c **** 
  73:../../picokernel/k_memp.c **** 		uint32_t pbase = (uint32_t)mem->mem_pool;
 170              		.loc 1 73 0 is_stmt 1
 171 000e D5F88C30 		ldr	r3, [r5, #140]
 172              	.LVL26:
  74:../../picokernel/k_memp.c **** 		uint32_t palloc = (uint32_t)p;
  75:../../picokernel/k_memp.c **** 		uint32_t block_position = ((palloc - pbase)/mem->block_size);
 173              		.loc 1 75 0
 174 0012 E41A     		subs	r4, r4, r3
 175              	.LVL27:
 176 0014 D5F88430 		ldr	r3, [r5, #132]
 177              	.LVL28:
 178 0018 B4FBF3F4 		udiv	r4, r4, r3
 179              	.LVL29:
  76:../../picokernel/k_memp.c **** 
  77:../../picokernel/k_memp.c **** 
  78:../../picokernel/k_memp.c **** 		/* bit position out of range, does not accept the block */
  79:../../picokernel/k_memp.c **** 		if(block_position < 1024) {
 180              		.loc 1 79 0
 181 001c B4F5806F 		cmp	r4, #1024
 182 0020 15D2     		bcs	.L10
  80:../../picokernel/k_memp.c **** 			x = (uint8_t)((block_position >> 5 )& 31);
 183              		.loc 1 80 0
 184 0022 C4F34413 		ubfx	r3, r4, #5, #5
 185              	.LVL30:
  81:../../picokernel/k_memp.c **** 			y = (uint8_t)(block_position & 31);
 186              		.loc 1 81 0
 187 0026 04F01F04 		and	r4, r4, #31
 188              	.LVL31:
  82:../../picokernel/k_memp.c **** 
  83:../../picokernel/k_memp.c **** 			mem->bitmap_h |= (1 << x);
 189              		.loc 1 83 0
 190 002a 0122     		movs	r2, #1
 191 002c 02FA03F6 		lsl	r6, r2, r3
 192 0030 2968     		ldr	r1, [r5]
 193 0032 3143     		orrs	r1, r1, r6
 194 0034 2960     		str	r1, [r5]
  84:../../picokernel/k_memp.c **** 			mem->bitmap_l[x] |= 1 << y;
 195              		.loc 1 84 0
 196 0036 02FA04F4 		lsl	r4, r2, r4
 197              	.LVL32:
 198 003a 05EB8303 		add	r3, r5, r3, lsl #2
 199              	.LVL33:
 200 003e 5A68     		ldr	r2, [r3, #4]
 201 0040 1443     		orrs	r4, r4, r2
ARM GAS  /tmp/ccTHXFXt.s 			page 6


 202 0042 5C60     		str	r4, [r3, #4]
 203              	.LVL34:
  85:../../picokernel/k_memp.c **** 			mem->numblocks++;
 204              		.loc 1 85 0
 205 0044 B5F88830 		ldrh	r3, [r5, #136]
 206 0048 0133     		adds	r3, r3, #1
 207 004a A5F88830 		strh	r3, [r5, #136]	@ movhi
 208              	.LVL35:
 209              	.L10:
 210              	.LBE5:
  86:../../picokernel/k_memp.c **** 		}
  87:../../picokernel/k_memp.c **** 	}
  88:../../picokernel/k_memp.c **** 
  89:../../picokernel/k_memp.c **** 
  90:../../picokernel/k_memp.c **** 	port_irq_unlock(key);
 211              		.loc 1 90 0
 212 004e FFF7FEFF 		bl	port_irq_unlock
 213              	.LVL36:
 214 0052 70BD     		pop	{r4, r5, r6, pc}
 215              		.cfi_endproc
 216              	.LFE21:
 218              		.text
 219              	.Letext0:
 220              		.file 2 "/home/venturus/gcc-arm-none-eabi-6-2017-q2-update/arm-none-eabi/include/machine/_default_
 221              		.file 3 "/home/venturus/gcc-arm-none-eabi-6-2017-q2-update/arm-none-eabi/include/sys/_stdint.h"
 222              		.file 4 "/home/venturus/gcc-arm-none-eabi-6-2017-q2-update/arm-none-eabi/include/sys/lock.h"
 223              		.file 5 "/home/venturus/gcc-arm-none-eabi-6-2017-q2-update/arm-none-eabi/include/sys/_types.h"
 224              		.file 6 "/home/venturus/gcc-arm-none-eabi-6-2017-q2-update/lib/gcc/arm-none-eabi/6.3.1/include/std
 225              		.file 7 "/home/venturus/gcc-arm-none-eabi-6-2017-q2-update/arm-none-eabi/include/sys/reent.h"
 226              		.file 8 "../../../uLipeRtosPico/ulipe_rtos_pico.h"
 227              		.file 9 "../../../uLipeRtosPico/include/picokernel/k_memp.h"
 228              		.file 10 "../../../uLipeRtosPico/include/picokernel/k_port.h"
ARM GAS  /tmp/ccTHXFXt.s 			page 7


DEFINED SYMBOLS
                            *ABS*:0000000000000000 k_memp.c
     /tmp/ccTHXFXt.s:18     .text.k_block_alloc:0000000000000000 $t
     /tmp/ccTHXFXt.s:25     .text.k_block_alloc:0000000000000000 k_block_alloc
     /tmp/ccTHXFXt.s:138    .text.k_block_free:0000000000000000 $t
     /tmp/ccTHXFXt.s:145    .text.k_block_free:0000000000000000 k_block_free
                     .debug_frame:0000000000000010 $d

UNDEFINED SYMBOLS
port_irq_lock
port_irq_unlock
port_bit_fs_scan
